"use strict";
/**
 * Schematic to automatically add support for using @ngx-i18nsupport.
 * Will be called when you call 'ng add @ngx-i18nsupport/tooling'.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const schematics_1 = require("@angular-devkit/schematics");
const tasks_1 = require("@angular-devkit/schematics/tasks");
const schematics_core_1 = require("../../schematics-core");
const common_1 = require("../common");
function addXliffmergeDependencyToPackageJson() {
    return (host, context) => {
        schematics_core_1.addPackageToPackageJson(host, 'devDependencies', common_1.xliffmergePackage, common_1.xliffmergeVersion);
        context.addTask(new tasks_1.NodePackageInstallTask());
        return host;
    };
}
function addExtractScriptToPackageJson(options) {
    return (host, context) => {
        schematics_core_1.addScriptToPackageJson(host, common_1.extractScriptName, common_1.fullExtractScript(options));
        context.logger.info(`added npm script to extract i18n message, run "npm run ${common_1.extractScriptName}" for extraction`);
        return host;
    };
}
/**
 * Sets all options given by commandline or defaults.
 * It also checks values for correctness.
 * @param optionsFromCommandline command line options.
 * @param context use for error logging.
 * @param host the tree to lookup some workspace settings.
 * @return an object where all relevant values are set.
 */
function setupOptions(optionsFromCommandline, host, context) {
    const options = common_1.setupCommonOptions(optionsFromCommandline, host, context);
    options.useComandlineForLanguages = optionsFromCommandline.useComandlineForLanguages ?
        optionsFromCommandline.useComandlineForLanguages
        : false;
    const languagesFromCommandline = (optionsFromCommandline.languages) ? optionsFromCommandline.languages.split(',') : [];
    if (!optionsFromCommandline.i18nLocale) {
        if (languagesFromCommandline.length > 0) {
            options.i18nLocale = languagesFromCommandline[0];
        }
        else {
            options.i18nLocale = common_1.defaultI18nLocale;
        }
    }
    options.parsedLanguages = [options.i18nLocale];
    if (optionsFromCommandline.languages) {
        options.parsedLanguages.push(...languagesFromCommandline);
    }
    // remove duplicates
    options.parsedLanguages = options.parsedLanguages.filter((v, i, a) => a.indexOf(v) === i);
    for (const lang of options.parsedLanguages) {
        if (!common_1.isValidLanguageSyntax(lang)) {
            const msg = `"${lang}" is not a valid language code.`;
            context.logger.fatal(msg);
            throw new schematics_1.SchematicsException(msg);
        }
    }
    return options;
}
// You don't have to export the function as default. You can also have more than one rule factory
// per file.
// noinspection JSUnusedGlobalSymbols
function ngAdd(optionsFromCommandline) {
    return (host, context) => {
        const options = setupOptions(optionsFromCommandline, host, context);
        const templateSource = schematics_1.apply(schematics_1.url('./files'), [
            schematics_1.template(Object.assign({}, schematics_core_1.stringUtils, options, { 'i18nLocale': options.i18nLocale, 'i18nFormat': options.i18nFormat })),
            schematics_1.move(options.path ? options.path : ''),
        ]);
        const configurationAdditions = options.parsedLanguages
            .filter(lang => lang !== options.i18nLocale)
            .map(lang => common_1.addLanguageConfigurationToProject(options, lang));
        const startScriptAdditions = options.parsedLanguages
            .filter(lang => lang !== options.i18nLocale)
            .map(lang => common_1.addStartScriptToPackageJson(options, lang));
        return schematics_1.chain([
            schematics_1.branchAndMerge(schematics_1.chain([
                addExtractScriptToPackageJson(options),
                ...configurationAdditions,
                ...startScriptAdditions,
                schematics_1.mergeWith(templateSource)
            ])),
            addXliffmergeDependencyToPackageJson(),
        ])(host, context);
    };
}
exports.ngAdd = ngAdd;
//# sourceMappingURL=index.js.map